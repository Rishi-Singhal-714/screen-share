<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Share App</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .screen {
            display: none;
            width: 100%;
            max-width: 1200px;
        }
        .screen.active {
            display: block;
        }
        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 32px;
        }
        h2 {
            color: #555;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .code-input {
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 100%;
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 3px;
            font-weight: bold;
        }
        .code-input:focus {
            border-color: #667eea;
            outline: none;
        }
        .btn {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin: 10px;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a67d8;
        }
        .btn-success {
            background: #48bb78;
            color: white;
        }
        .btn-danger {
            background: #f56565;
            color: white;
        }
        .btn-warning {
            background: #ed8936;
            color: white;
        }
        .error {
            color: #f56565;
            margin: 10px 0;
            display: none;
        }
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 15px;
            display: flex;
            gap: 10px;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0 100px 0;
        }
        .video-card {
            background: #1a202c;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.3s;
        }
        .video-card:hover {
            transform: scale(1.02);
        }
        .video-card.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 999;
            cursor: default;
        }
        video {
            width: 100%;
            height: 200px;
            background: #000;
            display: block;
        }
        .video-info {
            padding: 15px;
            background: rgba(0,0,0,0.7);
            color: white;
            position: absolute;
            bottom: 0;
            width: 100%;
        }
        .status {
            margin-top: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            font-size: 14px;
        }
        .status-connected {
            background: #48bb78;
            color: white;
        }
        .status-sharing {
            background: #ed8936;
            color: white;
        }
        .participant-count {
            background: #4299e1;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        .user-list {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
        }
        .user-item {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-item:last-child {
            border-bottom: none;
        }
        .badge-host {
            background: #ed8936;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Access Screen -->
    <div id="accessScreen" class="screen active">
        <div class="card">
            <h1>üîê Screen Share App</h1>
            <p style="color: #666; margin-bottom: 30px;">Share your screen with 2-4 people simultaneously</p>
            
            <input type="password" id="accessCode" class="code-input" 
                   placeholder="Enter 14-digit code" maxlength="14">
            
            <div id="error" class="error">Invalid access code!</div>
            
            <button id="enterBtn" class="btn btn-primary">Enter Room</button>
            
            <div style="margin-top: 30px; color: #718096;">
                <strong>Available Codes:</strong><br>
                <span style="font-family: monospace; font-size: 14px;">
                    251020031111222<br>
                    251020032222333<br>
                    251020033333444<br>
                    251020034444555
                </span>
            </div>
        </div>
    </div>

    <!-- Room Screen -->
    <div id="roomScreen" class="screen">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>üé¨ Screen Share Room</h2>
                <div class="participant-count">
                    üë• <span id="participantCount">1</span> online
                </div>
            </div>
            
            <div id="statusIndicator" class="status status-connected">
                ‚úì Connected
            </div>
            
            <div class="user-list" id="userList">
                <div style="color: #718096; margin-bottom: 10px;">Active Users:</div>
                <!-- Users will be added here -->
            </div>
            
            <div id="videoGrid" class="video-grid">
                <div style="text-align: center; color: #a0aec0; padding: 40px;">
                    <h3>No screens shared yet</h3>
                    <p>Be the first to share your screen!</p>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="controls">
                <button id="shareBtn" class="btn btn-success">üì∫ Start Sharing</button>
                <button id="stopBtn" class="btn btn-danger" style="display: none;">‚èπÔ∏è Stop Sharing</button>
                <button id="micBtn" class="btn btn-warning" style="display: none;">üé§ Mute</button>
                <button id="leaveBtn" class="btn btn-primary">üö™ Leave Room</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD6hUvKXNjR8e6cQNf2HpmybXp-7Qy7zTU", // Public test key
            projectId: "screenshare-12345", // Test project ID
            appId: "1:1234567890:web:abcdef123456"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // App State
        const state = {
            currentUser: null,
            currentStream: null,
            roomId: null,
            users: [],
            screens: [],
            isSharing: false,
            isMicMuted: false,
            fullscreenVideo: null
        };

        // DOM Elements
        const accessScreen = document.getElementById('accessScreen');
        const roomScreen = document.getElementById('roomScreen');
        const accessCodeInput = document.getElementById('accessCode');
        const enterBtn = document.getElementById('enterBtn');
        const errorDiv = document.getElementById('error');
        const videoGrid = document.getElementById('videoGrid');
        const shareBtn = document.getElementById('shareBtn');
        const stopBtn = document.getElementById('stopBtn');
        const micBtn = document.getElementById('micBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const participantCount = document.getElementById('participantCount');
        const userList = document.getElementById('userList');
        const statusIndicator = document.getElementById('statusIndicator');

        // Fixed Access Codes
        const ACCESS_CODES = [
            '251020031111222',
            '251020032222333',
            '251020033333444',
            '251020034444555',
            '251020035555666',
            '251020036666777',
            '251020037777888',
            '251020038888999',
            '251020039999000',
            '251020030000111'
        ];

        // Generate unique user ID
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Enter Room
        enterBtn.addEventListener('click', enterRoom);
        accessCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') enterRoom();
        });

        async function enterRoom() {
            const code = accessCodeInput.value.trim();
            
            if (!ACCESS_CODES.includes(code)) {
                errorDiv.style.display = 'block';
                accessCodeInput.style.borderColor = '#f56565';
                return;
            }
            
            errorDiv.style.display = 'none';
            accessCodeInput.style.borderColor = '#ddd';
            
            // Create user
            state.currentUser = {
                id: generateUserId(),
                name: `User_${Math.floor(Math.random() * 1000)}`,
                isHost: false,
                joinedAt: new Date().toISOString()
            };
            
            state.roomId = code;
            
            // Show room screen
            accessScreen.classList.remove('active');
            roomScreen.classList.add('active');
            
            // Connect to Firebase room
            await connectToRoom();
        }

        // Connect to Firebase Room
        async function connectToRoom() {
            statusIndicator.textContent = 'üîÑ Connecting...';
            statusIndicator.className = 'status status-connected';
            
            try {
                // Add user to room
                await db.collection('rooms').doc(state.roomId).collection('users').doc(state.currentUser.id).set({
                    ...state.currentUser,
                    lastSeen: new Date().toISOString()
                });
                
                // Listen for users in room
                db.collection('rooms').doc(state.roomId).collection('users').onSnapshot((snapshot) => {
                    state.users = [];
                    userList.innerHTML = '<div style="color: #718096; margin-bottom: 10px;">Active Users:</div>';
                    
                    snapshot.forEach((doc) => {
                        const user = doc.data();
                        state.users.push(user);
                        
                        // Add to user list
                        const userDiv = document.createElement('div');
                        userDiv.className = 'user-item';
                        userDiv.innerHTML = `
                            <div>
                                <strong>${user.name}</strong>
                                ${user.id === state.currentUser.id ? ' (You)' : ''}
                            </div>
                            <div class="${user.isHost ? 'badge-host' : ''}">
                                ${user.isHost ? 'Host' : 'Viewer'}
                            </div>
                        `;
                        userList.appendChild(userDiv);
                    });
                    
                    participantCount.textContent = state.users.length;
                });
                
                // Listen for screen shares
                db.collection('rooms').doc(state.roomId).collection('screens').onSnapshot((snapshot) => {
                    snapshot.forEach((doc) => {
                        const screenData = doc.data();
                        if (screenData.active) {
                            // If this is a remote screen share (not ours)
                            if (screenData.userId !== state.currentUser.id && screenData.sdp) {
                                receiveScreenStream(screenData);
                            }
                        }
                    });
                });
                
                statusIndicator.textContent = '‚úì Connected';
                statusIndicator.className = 'status status-connected';
                
                console.log('Connected to room:', state.roomId);
                
            } catch (error) {
                console.error('Error connecting to room:', error);
                statusIndicator.textContent = '‚úó Connection Error';
                statusIndicator.className = 'status status-error';
            }
        }

        // Start Screen Sharing
        shareBtn.addEventListener('click', startScreenSharing);

        async function startScreenSharing() {
            try {
                // Request screen share
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: "always",
                        displaySurface: "monitor"
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                });
                
                // Request microphone
                const micStream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });
                
                // Combine streams
                const combinedStream = new MediaStream([
                    ...stream.getVideoTracks(),
                    ...micStream.getAudioTracks()
                ]);
                
                state.currentStream = combinedStream;
                state.isSharing = true;
                
                // Update UI
                shareBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                micBtn.style.display = 'inline-block';
                
                // Mark as host
                state.currentUser.isHost = true;
                await db.collection('rooms').doc(state.roomId).collection('users').doc(state.currentUser.id).update({
                    isHost: true
                });
                
                // Add local video
                addVideoStream(combinedStream, 'Your Screen (Host)');
                
                // Save screen info to Firebase
                const screenDoc = db.collection('rooms').doc(state.roomId).collection('screens').doc(state.currentUser.id);
                await screenDoc.set({
                    userId: state.currentUser.id,
                    userName: state.currentUser.name,
                    active: true,
                    startedAt: new Date().toISOString()
                });
                
                // Handle track ending (user stops sharing)
                stream.getVideoTracks()[0].onended = async () => {
                    await stopScreenSharing();
                };
                
                // Update status
                statusIndicator.textContent = 'üî¥ Sharing Screen';
                statusIndicator.className = 'status status-sharing';
                
            } catch (error) {
                console.error('Error starting screen share:', error);
                alert('Could not start screen sharing. Please check permissions.');
            }
        }

        // Receive Screen Stream
        function receiveScreenStream(screenData) {
            // Create a video element for the remote stream
            // Note: In a real app, you would use WebRTC. For simplicity, we'll show a placeholder.
            // For actual video, you need a proper WebRTC implementation.
            
            // Check if video already exists
            const existingVideo = document.querySelector(`[data-user-id="${screenData.userId}"]`);
            if (!existingVideo) {
                const videoCard = document.createElement('div');
                videoCard.className = 'video-card';
                videoCard.dataset.userId = screenData.userId;
                
                videoCard.innerHTML = `
                    <video autoplay playsinline></video>
                    <div class="video-info">
                        <div style="display: flex; justify-content: space-between;">
                            <span>${screenData.userName}'s Screen</span>
                            <button class="btn btn-primary" onclick="requestToView(this)">View</button>
                        </div>
                    </div>
                `;
                
                videoGrid.appendChild(videoCard);
                
                // If we're the host sharing, don't add duplicate
                if (!state.isSharing) {
                    // Show message
                    const noStreamsDiv = videoGrid.querySelector('div');
                    if (noStreamsDiv && noStreamsDiv.textContent.includes('No screens')) {
                        noStreamsDiv.style.display = 'none';
                    }
                }
            }
        }

        // Request to view screen (simplified - in real app this would trigger WebRTC)
        function requestToView(button) {
            const videoCard = button.closest('.video-card');
            const userId = videoCard.dataset.userId;
            
            // In a real implementation, this would initiate WebRTC connection
            // For now, we'll just show a message
            alert('In a full implementation, this would connect to the host\'s screen via WebRTC.\n\nFor this demo: Host should use screen sharing apps like Discord/Zoom.\n\nThis app shows the structure for real implementation.');
        }

        // Stop Screen Sharing
        stopBtn.addEventListener('click', stopScreenSharing);

        async function stopScreenSharing() {
            if (state.currentStream) {
                state.currentStream.getTracks().forEach(track => track.stop());
                state.currentStream = null;
            }
            
            state.isSharing = false;
            
            // Update UI
            shareBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            micBtn.style.display = 'none';
            
            // Remove from Firebase
            await db.collection('rooms').doc(state.roomId).collection('screens').doc(state.currentUser.id).delete();
            
            // Remove local video
            const localVideo = document.querySelector('[data-user-id="local"]');
            if (localVideo) {
                localVideo.remove();
            }
            
            // Update status
            statusIndicator.textContent = '‚úì Connected';
            statusIndicator.className = 'status status-connected';
        }

        // Toggle Microphone
        micBtn.addEventListener('click', () => {
            if (state.currentStream) {
                const audioTracks = state.currentStream.getAudioTracks();
                if (audioTracks.length > 0) {
                    state.isMicMuted = !state.isMicMuted;
                    audioTracks.forEach(track => {
                        track.enabled = !state.isMicMuted;
                    });
                    micBtn.textContent = state.isMicMuted ? 'üé§ Unmute' : 'üé§ Mute';
                }
            }
        });

        // Add Video Stream (local only in this simplified version)
        function addVideoStream(stream, label) {
            // Remove existing local video
            const existing = document.querySelector('[data-user-id="local"]');
            if (existing) existing.remove();
            
            const videoCard = document.createElement('div');
            videoCard.className = 'video-card';
            videoCard.dataset.userId = 'local';
            
            videoCard.innerHTML = `
                <video autoplay playsinline></video>
                <div class="video-info">
                    <div style="display: flex; justify-content: space-between;">
                        <span>${label}</span>
                        <button class="btn btn-primary" onclick="toggleFullscreen(this)">Fullscreen</button>
                    </div>
                </div>
            `;
            
            const video = videoCard.querySelector('video');
            video.srcObject = stream;
            
            // Hide "no screens" message
            const noStreamsDiv = videoGrid.querySelector('div');
            if (noStreamsDiv && noStreamsDiv.textContent.includes('No screens')) {
                noStreamsDiv.style.display = 'none';
            }
            
            videoGrid.appendChild(videoCard);
        }

        // Toggle Fullscreen
        function toggleFullscreen(button) {
            const videoCard = button.closest('.video-card');
            
            if (state.fullscreenVideo === videoCard) {
                videoCard.classList.remove('fullscreen');
                state.fullscreenVideo = null;
            } else {
                if (state.fullscreenVideo) {
                    state.fullscreenVideo.classList.remove('fullscreen');
                }
                videoCard.classList.add('fullscreen');
                state.fullscreenVideo = videoCard;
                
                // Make video fill screen
                const video = videoCard.querySelector('video');
                video.style.height = 'calc(100vh - 100px)';
            }
        }

        // Leave Room
        leaveBtn.addEventListener('click', async () => {
            if (state.currentStream) {
                await stopScreenSharing();
            }
            
            // Remove user from Firebase
            if (state.currentUser && state.roomId) {
                await db.collection('rooms').doc(state.roomId).collection('users').doc(state.currentUser.id).delete();
            }
            
            // Reset
            state.currentUser = null;
            state.roomId = null;
            state.users = [];
            
            // Show access screen
            roomScreen.classList.remove('active');
            accessScreen.classList.add('active');
            
            // Clear video grid
            videoGrid.innerHTML = `
                <div style="text-align: center; color: #a0aec0; padding: 40px;">
                    <h3>No screens shared yet</h3>
                    <p>Be the first to share your screen!</p>
                </div>
            `;
        });

        // Auto-fill first code for testing
        window.addEventListener('load', () => {
            accessCodeInput.value = ACCESS_CODES[0];
            
            // Clean up old rooms (for demo purposes)
            const cleanupTime = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
            
            // Listen for cleanup message
            db.collection('cleanup').doc('lastCleanup').onSnapshot((doc) => {
                console.log('Cleanup tracker updated');
            });
        });

        // Handle page unload
        window.addEventListener('beforeunload', async () => {
            if (state.currentUser && state.roomId) {
                await db.collection('rooms').doc(state.roomId).collection('users').doc(state.currentUser.id).delete();
                if (state.isSharing) {
                    await db.collection('rooms').doc(state.roomId).collection('screens').doc(state.currentUser.id).delete();
                }
            }
        });

        // Auto-refresh users every 30 seconds
        setInterval(() => {
            if (state.currentUser && state.roomId) {
                db.collection('rooms').doc(state.roomId).collection('users').doc(state.currentUser.id).update({
                    lastSeen: new Date().toISOString()
                }).catch(console.error);
            }
        }, 30000);

        // Remove inactive users
        setInterval(async () => {
            if (state.roomId) {
                const cutoff = new Date(Date.now() - 60000).toISOString();
                const snapshot = await db.collection('rooms').doc(state.roomId).collection('users').get();
                
                snapshot.forEach(async (doc) => {
                    const user = doc.data();
                    if (user.lastSeen < cutoff) {
                        await doc.ref.delete();
                        // Also remove their screen if sharing
                        await db.collection('rooms').doc(state.roomId).collection('screens').doc(user.id).delete();
                    }
                });
            }
        }, 30000);
    </script>
</body>
</html>
