<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Screen Share</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            min-height: 100vh;
        }
        
        .screen { display: none; }
        .screen.active { display: block; }
        
        .access-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .access-box {
            background: white;
            color: #333;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        
        input, button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 16px;
        }
        
        input {
            border: 2px solid #ddd;
            text-align: center;
            letter-spacing: 2px;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .btn:hover { background: #45a049; }
        .btn-stop { background: #f44336; }
        .btn-stop:hover { background: #d32f2f; }
        
        .video-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 10px;
            display: flex;
            gap: 10px;
        }
        
        video {
            width: 100%;
            max-width: 800px;
            background: black;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .users {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px;
            font-size: 14px;
        }
        
        .connected { background: green; }
        .disconnected { background: red; }
    </style>
</head>
<body>
    <!-- Access Screen -->
    <div id="accessScreen" class="screen active">
        <div class="access-screen">
            <div class="access-box">
                <h2>ðŸš€ Live Screen Share</h2>
                <p>Enter access code to join room</p>
                <input type="password" id="roomCode" placeholder="Enter 251020031111222">
                <button id="joinBtn" class="btn">Join Room</button>
                <p id="error" style="color:red; display:none;">Invalid code!</p>
                <p style="margin-top:20px; font-size:12px; color:#666;">
                    Use code: <strong>251020031111222</strong>
                </p>
            </div>
        </div>
    </div>

    <!-- Room Screen -->
    <div id="roomScreen" class="screen">
        <div class="video-container">
            <h2>ðŸŽ¬ Room: <span id="roomName"></span></h2>
            <div class="status connected" id="connectionStatus">Connected</div>
            
            <div id="remoteVideo"></div>
            
            <div class="users">
                <h3>ðŸ‘¥ Online Users:</h3>
                <ul id="userList"></ul>
            </div>
        </div>
        
        <div class="controls">
            <button id="startShare" class="btn">Share Screen</button>
            <button id="stopShare" class="btn btn-stop" style="display:none;">Stop Sharing</button>
            <button id="leaveBtn" class="btn">Leave Room</button>
        </div>
    </div>

    <script>
        // Simple WebRTC with WebSocket
        const ACCESS_CODE = '251020031111222';
        
        let peerConnection;
        let localStream;
        let socket;
        let roomId;
        let userId = 'user_' + Math.random().toString(36).substr(2, 9);
        
        // DOM Elements
        const accessScreen = document.getElementById('accessScreen');
        const roomScreen = document.getElementById('roomScreen');
        const roomCodeInput = document.getElementById('roomCode');
        const joinBtn = document.getElementById('joinBtn');
        const errorMsg = document.getElementById('error');
        const roomName = document.getElementById('roomName');
        const startShareBtn = document.getElementById('startShare');
        const stopShareBtn = document.getElementById('stopShare');
        const leaveBtn = document.getElementById('leaveBtn');
        const remoteVideo = document.getElementById('remoteVideo');
        const userList = document.getElementById('userList');
        const connectionStatus = document.getElementById('connectionStatus');
        
        // Join Room
        joinBtn.onclick = () => {
            const code = roomCodeInput.value;
            if (code === ACCESS_CODE) {
                joinRoom(code);
            } else {
                errorMsg.style.display = 'block';
            }
        };
        
        roomCodeInput.value = ACCESS_CODE; // Auto-fill
        
        function joinRoom(code) {
            roomId = code;
            roomName.textContent = code;
            
            // Connect to WebSocket server
            connectWebSocket();
            
            // Show room screen
            accessScreen.classList.remove('active');
            roomScreen.classList.add('active');
        }
        
        function connectWebSocket() {
            // Use a free public WebSocket server
            socket = new WebSocket('wss://ws.postman-echo.com/raw');
            
            socket.onopen = () => {
                console.log('WebSocket connected');
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'status connected';
                
                // Join the room
                socket.send(JSON.stringify({
                    type: 'join',
                    roomId: roomId,
                    userId: userId
                }));
            };
            
            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    console.log('Message:', event.data);
                }
            };
            
            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
                connectionStatus.textContent = 'Connection Error';
                connectionStatus.className = 'status disconnected';
            };
            
            socket.onclose = () => {
                console.log('WebSocket disconnected');
                connectionStatus.textContent = 'Disconnected';
                connectionStatus.className = 'status disconnected';
            };
        }
        
        function handleMessage(data) {
            switch(data.type) {
                case 'user-list':
                    updateUserList(data.users);
                    break;
                case 'offer':
                    handleOffer(data.offer, data.sender);
                    break;
                case 'answer':
                    handleAnswer(data.answer);
                    break;
                case 'ice-candidate':
                    handleIceCandidate(data.candidate);
                    break;
                case 'screen-share-started':
                    showRemoteScreen(data.sender);
                    break;
                case 'screen-share-ended':
                    hideRemoteScreen(data.sender);
                    break;
            }
        }
        
        function updateUserList(users) {
            userList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.textContent = user + (user === userId ? ' (You)' : '');
                userList.appendChild(li);
            });
        }
        
        // Start Screen Sharing
        startShareBtn.onclick = async () => {
            try {
                localStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "always" },
                    audio: true
                });
                
                // Show local stream
                const video = document.createElement('video');
                video.srcObject = localStream;
                video.autoplay = true;
                video.controls = true;
                video.style.width = '100%';
                remoteVideo.innerHTML = '<h3>Your Shared Screen:</h3>';
                remoteVideo.appendChild(video);
                
                // Notify others
                socket.send(JSON.stringify({
                    type: 'screen-share-started',
                    roomId: roomId,
                    sender: userId
                }));
                
                // Start WebRTC for each viewer
                createPeerConnections();
                
                // Update UI
                startShareBtn.style.display = 'none';
                stopShareBtn.style.display = 'block';
                
            } catch (error) {
                console.error('Error sharing screen:', error);
                alert('Failed to share screen. Please allow permissions.');
            }
        };
        
        function createPeerConnections() {
            // Create peer connection
            const config = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            };
            
            peerConnection = new RTCPeerConnection(config);
            
            // Add local stream
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.send(JSON.stringify({
                        type: 'ice-candidate',
                        roomId: roomId,
                        candidate: event.candidate
                    }));
                }
            };
            
            // Create offer
            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    socket.send(JSON.stringify({
                        type: 'offer',
                        roomId: roomId,
                        offer: peerConnection.localDescription
                    }));
                });
        }
        
        function handleOffer(offer, sender) {
            if (!peerConnection) {
                const config = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' }
                    ]
                };
                peerConnection = new RTCPeerConnection(config);
                
                peerConnection.ontrack = (event) => {
                    // Display remote stream
                    const video = document.createElement('video');
                    video.srcObject = event.streams[0];
                    video.autoplay = true;
                    video.controls = true;
                    video.style.width = '100%';
                    remoteVideo.innerHTML = `<h3>${sender}'s Screen:</h3>`;
                    remoteVideo.appendChild(video);
                };
                
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.send(JSON.stringify({
                            type: 'ice-candidate',
                            roomId: roomId,
                            candidate: event.candidate
                        }));
                    }
                };
            }
            
            peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
                .then(() => peerConnection.createAnswer())
                .then(answer => peerConnection.setLocalDescription(answer))
                .then(() => {
                    socket.send(JSON.stringify({
                        type: 'answer',
                        roomId: roomId,
                        answer: peerConnection.localDescription
                    }));
                });
        }
        
        function handleAnswer(answer) {
            if (peerConnection) {
                peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            }
        }
        
        function handleIceCandidate(candidate) {
            if (peerConnection) {
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            }
        }
        
        function showRemoteScreen(sender) {
            if (!document.querySelector('#remoteVideo video')) {
                const video = document.createElement('video');
                video.id = 'remoteVideoElement';
                video.autoplay = true;
                video.controls = true;
                video.style.width = '100%';
                video.innerHTML = `<h3>${sender} is sharing screen...</h3>`;
                remoteVideo.innerHTML = `<h3>${sender}'s Screen:</h3>`;
                remoteVideo.appendChild(video);
            }
        }
        
        function hideRemoteScreen(sender) {
            remoteVideo.innerHTML = `<p>${sender} stopped sharing</p>`;
        }
        
        // Stop Sharing
        stopShareBtn.onclick = () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            remoteVideo.innerHTML = '<p>Screen sharing stopped</p>';
            
            // Notify others
            socket.send(JSON.stringify({
                type: 'screen-share-ended',
                roomId: roomId,
                sender: userId
            }));
            
            // Update UI
            startShareBtn.style.display = 'block';
            stopShareBtn.style.display = 'none';
        };
        
        // Leave Room
        leaveBtn.onclick = () => {
            if (socket) socket.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            if (peerConnection) peerConnection.close();
            
            accessScreen.classList.add('active');
            roomScreen.classList.remove('active');
        };
        
        // Auto-reconnect if disconnected
        setInterval(() => {
            if (socket && socket.readyState === WebSocket.CLOSED) {
                console.log('Reconnecting...');
                connectWebSocket();
            }
        }, 5000);
    </script>
</body>
</html>
